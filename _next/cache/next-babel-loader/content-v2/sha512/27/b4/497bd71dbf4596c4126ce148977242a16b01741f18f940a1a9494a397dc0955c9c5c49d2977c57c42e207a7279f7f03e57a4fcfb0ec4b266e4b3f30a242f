{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport { KEYS } from '../utils/constants';\nimport { createError, unWrapError } from '../utils/createError';\nimport { getNowMon } from '../utils/date';\nimport { Messager } from '../utils/message';\nimport { ptbk } from '../utils/ptbk';\nimport { toQueryStr } from '../utils/toQueryStr';\nimport { getHost } from '../utils/url';\nimport { ApiConfig } from './apiConfig';\nimport { getHeaderAuth, getToken, setHeaderAuth } from './getToken';\nimport { getMetadata, rewriteUrl, setMetadata } from './utils';\n\n/**\n * 输出调试信息\n */\nexport var printResUrlTime = function printResUrlTime(res) {\n  if (ApiConfig.log) {\n    var req = res.config;\n\n    if (req) {\n      var _console;\n\n      var reqUrl = req.baseURL + req.url;\n\n      if (req.params) {\n        var queryUrl = toQueryStr(req.params);\n\n        if (reqUrl.includes('?')) {\n          queryUrl = '&' + queryUrl;\n        } else {\n          queryUrl = '?' + queryUrl;\n        }\n\n        reqUrl += queryUrl;\n      }\n\n      if (false) {\n        reqUrl = rewriteUrl(reqUrl);\n      }\n\n      var duration = getMetadata(res, 'duration');\n      var optionalParams = [getNowMon().format('YYYY-MM-DD HH:mm:ss'), reqUrl];\n\n      if (duration) {\n        optionalParams = optionalParams.concat(\"[duration]: \".concat(duration, \"ms\"));\n        setMetadata(res, 'duration', duration);\n      }\n\n      (_console = console).log.apply(_console, _toConsumableArray(optionalParams));\n    }\n  }\n\n  return res;\n};\nexport var printResData = function printResData(res) {\n  if (ApiConfig.log) {\n    console.log(res);\n  }\n\n  return res;\n};\n/**\n * 客户端重新抛出被服务端吞掉的错误\n */\n\nexport var reThrowError = function reThrowError(res) {\n  var error = unWrapError(res === null || res === void 0 ? void 0 : res.data);\n\n  if (error) {\n    return Promise.reject(error);\n  }\n\n  return res;\n};\n/**\n * 去掉代理用的 ^/api\n */\n\nexport var rewriteApiUrl = function rewriteApiUrl(req) {\n  req.url = rewriteUrl(req.url, ApiConfig.proxyApi);\n  return req;\n};\n/**\n * 客户端报错提示\n */\n\nexport var setClientErrorMessage = function setClientErrorMessage(res) {\n  var error = res.data[KEYS.error];\n\n  if (error) {\n    if (ApiConfig.log) {\n      // 输出错误信息\n      Messager.error(error);\n    }\n  }\n\n  return res;\n};\n/**\n * 计算接口请求时间\n */\n\nexport var calcRequestTimeStart = function calcRequestTimeStart(req) {\n  if (ApiConfig.log) {\n    setMetadata(req, 'startTime', new Date());\n  }\n\n  return req;\n};\n/**\n * 计算接口请求时间\n */\n\nexport var calcRequestTimeEnd = function calcRequestTimeEnd(res) {\n  if (ApiConfig.log) {\n    var endTime = new Date();\n    var startTime = getMetadata(res, 'startTime');\n    setMetadata(res, 'duration', Number(endTime) - Number(startTime));\n  }\n\n  return res;\n};\n/**\n * 转发时如果需要，代理验证host\n */\n\nexport var changeOrigin = function changeOrigin(req) {\n  var _req$headers;\n\n  var headers = (_req$headers = req.headers) !== null && _req$headers !== void 0 ? _req$headers : {};\n  headers.host = getHost(req.baseURL);\n  req.headers = headers;\n  return req;\n};\n/**\n * axios异常全局处理（服务端渲染）\n */\n\nexport var handleError = function handleError(error) {\n  var _error$request, _error$request$res;\n\n  console.log('[error]:', error === null || error === void 0 ? void 0 : error.message, error === null || error === void 0 ? void 0 : (_error$request = error.request) === null || _error$request === void 0 ? void 0 : (_error$request$res = _error$request.res) === null || _error$request$res === void 0 ? void 0 : _error$request$res.responseUrl);\n  return {\n    data: _defineProperty({}, KEYS.error, createError(error))\n  };\n};\nexport var decodeApiPtbk = function decodeApiPtbk(res) {\n  if (ptbk.isPtbk(res === null || res === void 0 ? void 0 : res.data)) {\n    res.data = ptbk.decode(res === null || res === void 0 ? void 0 : res.data);\n  }\n\n  return res;\n};\n/**\n * 客户端自动携带token\n */\n\nexport var autoWithClientToken = function autoWithClientToken(req) {\n  var headers = req.headers;\n\n  if (headers) {\n    var token = getToken();\n\n    if (token) {\n      setHeaderAuth(headers, token);\n    }\n  }\n\n  return req;\n};\n/**\n * 代理服务端如何发送token\n */\n\nexport var resolveServerToken = function resolveServerToken(req) {\n  var headers = req.headers;\n\n  if (headers) {\n    var token = getHeaderAuth(headers);\n\n    if (token) {// 例如放到cookie中\n      // 不处理就是auth header\n    }\n  }\n\n  return req;\n};","map":null,"metadata":{},"sourceType":"module"}